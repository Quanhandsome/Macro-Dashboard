<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Macro Dashboard (FRED + CORS proxy)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--text:#111;--muted:#666;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid #eaeaea;padding:12px 16px;display:flex;gap:12px;align-items:center;z-index:10}
    h1{font-size:18px;margin:0 8px 0 0}
    select{padding:6px 8px;border:1px solid #ddd;border-radius:8px;background:#fff}
    main{padding:16px;display:grid;grid-template-columns:1fr;gap:16px;max-width:1400px;margin:0 auto}
    @media (min-width:900px){main{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid #eee;border-radius:14px;box-shadow:0 2px 6px rgba(0,0,0,.04);padding:14px}
    .title{margin:0 0 8px 0;font-weight:600}
    .subtitle{margin:0 0 12px 0;color:var(--muted);font-size:13px}
    canvas{width:100% !important;height:320px !important}
    #status{position:fixed;right:12px;bottom:12px;max-width:520px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;font-size:12px;line-height:1.4;white-space:pre-wrap;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    #status.hidden{display:none}
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header>
    <h1>Macro Dashboard</h1>
    <label>Timeframe:
      <select id="timeframe">
        <option value="a">Year</option>
        <option value="q">Quarter</option>
        <option value="m" selected>Month</option>
        <option value="w">Week</option>
      </select>
    </label>
    <small style="color:#888">Nguồn: FRED (qua CORS proxy)</small>
  </header>

  <div id="status" class="hidden"></div>

  <main>
    <section class="card">
      <h3 class="title">Prices & Inflation</h3>
      <p class="subtitle">CPI, Core CPI, PCE, Core PCE</p>
      <canvas id="inflationChart"></canvas>
    </section>

    <section class="card">
      <h3 class="title">Policy & Yield Curve</h3>
      <p class="subtitle">Fed Funds Rate, 10Y–2Y Spread</p>
      <canvas id="policyChart"></canvas>
    </section>

    <section class="card">
      <h3 class="title">Money & Balance Sheet</h3>
      <p class="subtitle">M2, Fed Balance Sheet (WALCL)</p>
      <canvas id="moneyChart"></canvas>
    </section>

    <section class="card">
      <h3 class="title">Growth & Activity</h3>
      <p class="subtitle">GDP, Industrial Production, Retail Sales</p>
      <canvas id="growthChart"></canvas>
    </section>

    <section class="card">
      <h3 class="title">Surveys & Sentiment</h3>
      <p class="subtitle">PMI (ISM), UMich Sentiment</p>
      <canvas id="sentimentChart"></canvas>
    </section>

    <section class="card">
      <h3 class="title">Equities</h3>
      <p class="subtitle">S&P 500 (FRED)</p>
      <canvas id="equityChart"></canvas>
    </section>

    <section class="card">
      <h3 class="title">Commodities & USD</h3>
      <p class="subtitle">Gold, WTI Oil, Broad USD</p>
      <canvas id="commoditiesChart"></canvas>
    </section>

    <section class="card">
      <h3 class="title">Crypto</h3>
      <p class="subtitle">Bitcoin (Coinbase USD on FRED)</p>
      <canvas id="btcChart"></canvas>
    </section>
  </main>

  <script>
    // ====== CONFIG ======
    const FRED_KEY = "2a302371de3d9e50c4820b561604a060"; // key của bro
    const START = "2005-01-01";

    // CORS proxies (thứ tự ưu tiên)
    const PROXIES = [
      (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
      (url) => `https://r.jina.ai/https://${url.replace(/^https?:\/\//,'')}`
    ];

    const SERIES = {
      inflation: [
        { id: "CPIAUCSL", label: "CPI (All Items)" },
        { id: "CPILFESL", label: "Core CPI" },
        { id: "PCEPI",    label: "PCE Price Index" },
        { id: "PCEPILFE", label: "Core PCE" },
      ],
      policy: [
        { id: "FEDFUNDS", label: "Fed Funds Rate (%)" },
        { id: "T10Y2Y",   label: "10Y–2Y Spread (%)" },
      ],
      money: [
        { id: "M2SL",  label: "M2 (Level)" },
        { id: "WALCL", label: "Fed Balance Sheet" },
      ],
      growth: [
        { id: "GDP",    label: "GDP (SAAR, Bil.$)" }, // quarterly
        { id: "INDPRO", label: "Industrial Production" }, // monthly
        { id: "RSAFS",  label: "Retail Sales (Advance)" }, // monthly
      ],
      sentiment: [
        { id: "NAPM",    label: "ISM PMI" },
        { id: "UMCSENT", label: "UMich Sentiment" },
      ],
      equity: [
        { id: "SP500", label: "S&P 500" },
      ],
      commodities: [
        { id: "GOLDPMGBD228NLBM", label: "Gold (PM Fix USD/oz)" },
        { id: "DCOILWTICO",       label: "WTI Crude (USD/bbl)" },
        { id: "DTWEXBGS",         label: "Broad USD Index" },
      ],
      btc: [
        { id: "CBBTCUSD", label: "Bitcoin (USD)" },
      ],
    };

    const $ = (sel) => document.querySelector(sel);
    const statusBox = $('#status');
    function logStatus(msg, isError=false){
      statusBox.classList.remove('hidden');
      statusBox.textContent = (statusBox.textContent ? statusBox.textContent + "\n" : "") + (isError ? "⚠️ " : "ℹ️ ") + msg;
    }

    // Fetch JSON with CORS fallbacks
    async function fetchJSONWithProxy(url) {
      // thử trực tiếp (nếu server cho CORS)
      try {
        const res = await fetch(url, { credentials: "omit" });
        if (res.ok) return await res.json();
        throw new Error(`HTTP ${res.status}`);
      } catch (e1) {
        // thử proxy 1
        try {
          const res2 = await fetch(PROXIES[0](url), { credentials: "omit" });
          if (res2.ok) return await res2.json();
          throw new Error(`Proxy1 HTTP ${res2.status}`);
        } catch (e2) {
          // thử proxy 2
          const res3 = await fetch(PROXIES[1](url), { credentials: "omit" });
          if (res3.ok) {
            // Jina proxy trả về text -> parse JSON
            const txt = await res3.text();
            try { return JSON.parse(txt); }
            catch { throw new Error("Proxy2 parse error"); }
          }
          throw new Error("All proxies failed");
        }
      }
    }

    // FRED fetch (có freq + aggregation end-of-period để “Year/Quarter/Month/Week” đẹp)
    async function fetchFRED(seriesId, freqCode){
      const u = new URL("https://api.stlouisfed.org/fred/series/observations");
      u.searchParams.set("series_id", seriesId);
      u.searchParams.set("api_key", FRED_KEY);
      u.searchParams.set("file_type", "json");
      if (START) u.searchParams.set("observation_start", START);
      if (freqCode) u.searchParams.set("frequency", freqCode); // a/q/m/w
      // dùng eop để lấy điểm cuối kỳ cho đường đẹp (đỡ “trung bình”)
      if (freqCode && freqCode !== "d") u.searchParams.set("aggregation_method", "eop");

      try{
        const json = await fetchJSONWithProxy(u.toString());
        if (!json || !json.observations) throw new Error("invalid payload");
        return json.observations
          .map(o => ({ date: o.date, value: o.value === "." ? null : Number(o.value) }))
          .filter(d => Number.isFinite(d.value));
      }catch(err){
        logStatus(`${seriesId}: ${err.message}`, true);
        return [];
      }
    }

    function mergeLabels(arrOfSeries){
      const set = new Set();
      arrOfSeries.forEach(s => s.forEach(p => set.add(p.date)));
      return Array.from(set).sort();
    }

    function toDataset(label, color, labels, series){
      const map = new Map(series.map(p => [p.date, p.value]));
      return {
        label,
        data: labels.map(d => (map.has(d) ? map.get(d) : null)),
        borderWidth: 1.8,
        pointRadius: 0,
        tension: 0.2,
        borderColor: color
      };
    }

    const charts = {};

    async function drawGroup(canvasId, seriesList, freqCode){
      const dataList = await Promise.all(seriesList.map(s => fetchFRED(s.id, freqCode)));
      const labels = mergeLabels(dataList);
      const palette = [
        "#2563eb","#dc2626","#059669","#7c3aed","#f59e0b",
        "#0ea5e9","#ef4444","#16a34a","#a855f7","#d97706"
      ];
      const datasets = dataList.map((ser, i) =>
        toDataset(seriesList[i].label, palette[i%palette.length], labels, ser)
      );

      const ctx = document.getElementById(canvasId).getContext("2d");
      if (charts[canvasId]) charts[canvasId].destroy();
      charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true, maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { position: 'top' } },
          scales: {
            x: { grid: { display:false } },
            y: { grid: { color: 'rgba(0,0,0,0.06)' }, ticks:{ maxTicksLimit: 6 } }
          }
        }
      });
    }

    async function loadAll(){
      statusBox.textContent = ""; statusBox.classList.add('hidden');
      const freq = document.getElementById('timeframe').value; // a/q/m/w
      await drawGroup("inflationChart",   SERIES.inflation,   freq);
      await drawGroup("policyChart",      SERIES.policy,      freq);
      await drawGroup("moneyChart",       SERIES.money,       freq);
      await drawGroup("growthChart",      SERIES.growth,      freq);
      await drawGroup("sentimentChart",   SERIES.sentiment,   freq);
      await drawGroup("equityChart",      SERIES.equity,      freq);
      await drawGroup("commoditiesChart", SERIES.commodities, freq);
      await drawGroup("btcChart",         SERIES.btc,         freq);
      logStatus("Done ✔");
      setTimeout(()=>statusBox.classList.add('hidden'), 2500);
    }

    document.getElementById('timeframe').addEventListener('change', loadAll);
    window.addEventListener('load', loadAll);
  </script>
</body>
</html>
