<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Macro Dashboard</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/javascript">
    const { useState, useEffect } = React;
    const {
      LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer
    } = Recharts;

    const API_KEY = "2a302371de3d9e50c4820b561604a060";
    const YAHOO_SYMBOLS = {
      sp500: "^GSPC",
      vnindex: "^VNINDEX",
      gold: "GC=F",
      oil: "CL=F",
      dxy: "DX-Y.NYB",
      bitcoin: "BTC-USD",
    };

    async function fetchFRED(series_id) {
      const url = `https://api.stlouisfed.org/fred/series/observations?series_id=${series_id}&api_key=${API_KEY}&file_type=json`;
      const res = await fetch(url);
      const data = await res.json();
      return data.observations.map(d => ({
        date: d.date,
        value: d.value === "." ? null : parseFloat(d.value)
      }));
    }

    async function fetchYahoo(symbol) {
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=5y&interval=1d`;
      const res = await fetch(url);
      const data = await res.json();
      const timestamps = data.chart.result[0].timestamp;
      const prices = data.chart.result[0].indicators.quote[0].close;
      return timestamps.map((t, i) => ({
        date: new Date(t * 1000).toISOString().split("T")[0],
        value: prices[i]
      }));
    }

    function filterData(series, timeframe) {
      if (!series) return [];
      const grouped = {};
      series.forEach(d => {
        const date = new Date(d.date);
        let key;
        if (timeframe === "year") {
          key = date.getFullYear();
        } else if (timeframe === "quarter") {
          key = `${date.getFullYear()}-Q${Math.floor(date.getMonth() / 3) + 1}`;
        } else if (timeframe === "month") {
          key = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,"0")}`;
        } else {
          const week = Math.ceil(date.getDate()/7);
          key = `${date.getFullYear()}-W${week}`;
        }
        grouped[key] = d;
      });
      return Object.entries(grouped).map(([date, val]) => ({...val, date}));
    }

    function ChartCard({ title, series, timeframe }) {
      return (
        React.createElement("div", { className: "bg-white shadow-md rounded-xl p-4 m-2" },
          React.createElement("h2", { className: "text-lg font-semibold mb-2" }, title),
          React.createElement(ResponsiveContainer, { width: "100%", height: 300 },
            React.createElement(LineChart, null,
              React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
              React.createElement(XAxis, { dataKey: "date" }),
              React.createElement(YAxis, null),
              React.createElement(Tooltip, null),
              React.createElement(Legend, null),
              series.map((s, i) =>
                React.createElement(Line, {
                  key: i,
                  type: "monotone",
                  dataKey: "value",
                  data: filterData(s.data, timeframe),
                  name: s.name,
                  stroke: s.color || "#8884d8",
                  dot: false
                })
              )
            )
          )
        )
      );
    }

    function App() {
      const [data, setData] = useState({});
      const [timeframe, setTimeframe] = useState("year");

      useEffect(() => {
        async function loadData() {
          const results = {};
          results.gdp = await fetchFRED("GDP");
          results.cpi = await fetchFRED("CPIAUCSL");
          results.corecpi = await fetchFRED("CPILFESL");
          results.pce = await fetchFRED("PCEPI");
          results.unemployment = await fetchFRED("UNRATE");
          results.m2 = await fetchFRED("M2SL");
          results.fedfunds = await fetchFRED("FEDFUNDS");
          results.yieldcurve = await fetchFRED("T10Y2Y");
          results.consumerSentiment = await fetchFRED("UMCSENT");
          results.pmi = await fetchFRED("NAPM");

          results.sp500 = await fetchYahoo(YAHOO_SYMBOLS.sp500);
          results.vnindex = await fetchYahoo(YAHOO_SYMBOLS.vnindex);
          results.gold = await fetchYahoo(YAHOO_SYMBOLS.gold);
          results.oil = await fetchYahoo(YAHOO_SYMBOLS.oil);
          results.dxy = await fetchYahoo(YAHOO_SYMBOLS.dxy);
          results.bitcoin = await fetchYahoo(YAHOO_SYMBOLS.bitcoin);

          setData(results);
        }
        loadData();
      }, []);

      return (
        React.createElement("div", { className: "p-6 grid grid-cols-1 md:grid-cols-2 gap-4" },
          React.createElement("div", { className: "col-span-full flex items-center gap-4 mb-6" },
            React.createElement("label", { className: "font-semibold" }, "Timeframe:"),
            React.createElement("select", {
              value: timeframe,
              onChange: e => setTimeframe(e.target.value),
              className: "border px-2 py-1 rounded"
            },
              React.createElement("option", { value: "year" }, "Year"),
              React.createElement("option", { value: "quarter" }, "Quarter"),
              React.createElement("option", { value: "month" }, "Month"),
              React.createElement("option", { value: "week" }, "Week")
            )
          ),

          ChartCard({ title: "Lạm phát (CPI / Core CPI / PCE)", timeframe,
            series: [
              { name: "CPI", data: data.cpi || [], color: "#FF0000" },
              { name: "Core CPI", data: data.corecpi || [], color: "#00AA00" },
              { name: "PCE", data: data.pce || [], color: "#0000FF" },
            ]
          }),
          ChartCard({ title: "Kinh tế (GDP, PMI, Consumer Sentiment)", timeframe,
            series: [
              { name: "GDP", data: data.gdp || [], color: "#0088FE" },
              { name: "PMI", data: data.pmi || [], color: "#FFBB28" },
              { name: "Sentiment", data: data.consumerSentiment || [], color: "#FF8042" },
            ]
          }),
          ChartCard({ title: "Thị trường chứng khoán", timeframe,
            series: [
              { name: "S&P500", data: data.sp500 || [], color: "#0055FF" },
              { name: "VNIndex", data: data.vnindex || [], color: "#FF5500" },
            ]
          }),
          ChartCard({ title: "Hàng hóa & Tiền tệ", timeframe,
            series: [
              { name: "Gold", data: data.gold || [], color: "#FFD700" },
              { name: "Oil", data: data.oil || [], color: "#222222" },
              { name: "DXY", data: data.dxy || [], color: "#00CED1" },
            ]
          }),
          ChartCard({ title: "Crypto", timeframe,
            series: [
              { name: "Bitcoin", data: data.bitcoin || [], color: "#F7931A" },
            ]
          }),
          ChartCard({ title: "Chính sách tiền tệ", timeframe,
            series: [
              { name: "Fed Funds Rate", data: data.fedfunds || [], color: "#006400" },
              { name: "Yield Curve (10Y-2Y)", data: data.yieldcurve || [], color: "#800080" },
              { name: "M2 Supply", data: data.m2 || [], color: "#FF4500" },
            ]
          })
        )
      );
    }

    ReactDOM.render(React.createElement(App), document.getElementById("root"));
  </script>
</body>
</html>
